@page "/giay/{GiayId:guid}"
@using API.Models.DTO
@using BlazorKhachHang.Service.IService
@inject IGiayService GiayService
@inject IGiayChiTietService GiayChiTietService
@inject IGioHangService GioHangService
@inject NavigationManager Nav

@if (giay == null)
{
    <p>Đang tải thông tin sản phẩm...</p>
}
else
{
    <div class="container mt-4">
        <div class="row">
            <!-- Ảnh sản phẩm -->
            <div class="col-md-6 text-center">
                <img src="@(giay.ChiTietGiays?.FirstOrDefault()?.AnhGiay ?? "/images/no-image.png")"
                     class="img-fluid rounded shadow"
                     style="max-height:400px;object-fit:cover;" />
            </div>

            <!-- Thông tin sản phẩm -->
            <div class="col-md-6">
                <h2 class="fw-bold">@giay.TenGiay</h2>
                <p class="text-muted mb-1">
                    Thương hiệu: <strong>@giay.TenThuongHieu</strong>
                </p>
                <p class="text-muted mb-3">
                    Thể loại: <strong>@giay.TenTheLoaiGiay</strong>
                </p>

                <h4 class="text-danger fw-bold mb-4">
                    Giá: @(giay.ChiTietGiays?.FirstOrDefault()?.Gia.ToString("N0")) đ
                </h4>

                <!-- Chọn màu -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Chọn màu:</label>
                    <select class="form-select" @bind="selectedColor">
                        <option value="">-- Chọn màu --</option>
                        @foreach (var color in colors)
                        {
                            <option value="@color">@color</option>
                        }
                    </select>
                </div>

                <!-- Chọn size -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Chọn size:</label>
                    <select class="form-select" @bind="selectedSize">
                        <option value="">-- Chọn size --</option>
                        @foreach (var size in sizes)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>
                </div>

                <!-- Số lượng -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Số lượng:</label>
                    <input type="number" class="form-control"
                           min="1" @bind="quantity" style="max-width:120px;" />
                </div>

                <!-- Nút thêm vào giỏ -->
                <button class="btn btn-lg btn-primary px-4 me-2"
                        @onclick="AddToCart">
                    🛒 Thêm vào giỏ hàng
                </button>

                <button class="btn btn-outline-secondary btn-lg"
                        @onclick="GoBack">
                    ⬅ Quay lại
                </button>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert alert-info mt-3">@message</div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid GiayId { get; set; }
    private GiayDTO? giay;
    private List<GiayChiTietDTO>? chiTietList;
    private List<string> colors = new();
    private List<string> sizes = new();

    private string? selectedColor;
    private string? selectedSize;
    private int quantity = 1;
    private string? message;

    protected override async Task OnInitializedAsync()
    {
        giay = await GiayService.GetByIdAsync(GiayId);
        chiTietList = await GiayChiTietService.GetByGiayIdAsync(GiayId);

        if (chiTietList != null)
        {
            colors = chiTietList.Select(c => c.TenMau).Distinct().ToList();
            sizes = chiTietList.Select(c => c.size.ToString()).Distinct().ToList();
        }
    }

    private async Task AddToCart()
    {
        if (string.IsNullOrEmpty(selectedColor) || string.IsNullOrEmpty(selectedSize))
        {
            message = "⚠️ Vui lòng chọn màu và size trước khi thêm vào giỏ hàng!";
            return;
        }

        var chiTiet = chiTietList?.FirstOrDefault(x =>
            x.TenMau == selectedColor && x.size.ToString() == selectedSize);

        if (chiTiet == null)
        {
            message = "⚠️ Không tìm thấy sản phẩm với lựa chọn này.";
            return;
        }

        await GioHangService.AddToCartAsync(Guid.Empty, chiTiet.GiayChiTietId, quantity);
        message = "✅ Đã thêm vào giỏ hàng!";
    }

    private void GoBack()
    {
        Nav.NavigateTo("/");
    }
}
